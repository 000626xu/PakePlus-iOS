name: Build Unsigned IPA

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build:
        runs-on: macOS-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Xcode
              run: |
                  sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
                  xcodebuild -version

            - name: Build .xcarchive (unsigned)
              run: |
                  xcodebuild \
                    -workspace PakePlus.xcworkspace \
                    -scheme PakePlus \
                    -configuration Release \
                    -destination 'generic/platform=iOS' \
                    -archivePath build/PakePlus.xcarchive \
                    CODE_SIGN_IDENTITY="" \
                    CODE_SIGNING_REQUIRED=NO \
                    CODE_SIGNING_ALLOWED=NO \
                    archive

            - name: Export .ipa (unsigned)
              run: |
                  xcodebuild \
                    -exportArchive \
                    -archivePath build/PakePlus.xcarchive \
                    -exportPath build \
                    -exportOptionsPlist exportOptions.plist \
                    CODE_SIGN_IDENTITY="" \
                    CODE_SIGNING_REQUIRED=NO \
                    CODE_SIGNING_ALLOWED=NO

            - name: Upload IPA artifact
              uses: actions/upload-artifact@v3
              with:
                  name: PakePlus-unsigned.ipa
                  path: build/PakePlus.ipa
